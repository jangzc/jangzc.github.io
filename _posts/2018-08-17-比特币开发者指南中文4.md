---
layout:     post
title:      比特币开发者指南(3)--合约
subtitle:   
date:       2018-08-17
author:     Jang
header-img: img/post-bg-debug.png
catalog: true
tags:
    - BlockChain
---

## 合约

合约是使用去中心化的比特币系统来执行财务协议的交易。通常可以制定比特币合约，以尽量减少对外部代理的依赖，例如法院系统，这显著降低了与金融交易中未知实体交易的风险。

以下小节将描述已经使用的各种比特币合约。因为合约是与真人打交道，而不仅仅是交易，它们在特定故事格式框架之中。

除了下述的合约类型，还提出了许多其他合约类型。其中几个收集在BitcoinWiki的合约页面.

## 托管和仲裁

Charlie客户想从Bob商人购买一种产品，但他们都不信任对方，所以他们使用合同帮助确保Charlie获得商品，Bob获得付款。
一个简单的合同可以说Charlie会把satoshihs花费到某个输出，只有Charlie和Bob都签名了这个输入才能花费它。这意味着bob不会得到报酬，除非Charlie得到他的商品，但查理无法既获得商品又保留他的付款。

如果有争议，这个简单的合约没有什么帮助，所以Bob和Charlie征求了Alice仲裁员的帮助来创建一个托管合约。Charlie花费这些satashis到一个输出，这个输出只有三人中的两人都签名输入的话才能被花费。现在如果一切正常Charlie可以支付给Bob,如果有问题的话Bob可以退款，或者如果有争议的话Alice可以仲裁并决定谁应该得到satoshis。

要创建一个多重签名(multisig)输出，他们每个给他人一个公钥。然后Bob创建以下P2SH multisig redeem脚本:
```
OP_2 [A's pubkey][B's pubkey][C's pubkey] OP_3 CHECKMULTISIG
```
OP_2和OP_3将实际数字2和3压入堆栈上。OP_2指定需要2个签名，OP_3指定需要提供3个未哈希过的公钥。这是一个2-of-3 multisig pubkey脚本，更一般地成为m-of-n pubkey脚本(m是需要的最小匹配的签名，n是提供公钥的数量).
Bob向Charlie发送redeem脚本，Charlie检查确定他的公钥和Alice的公钥。然后，他将redeem脚本求哈希，来创建P2SH redeem脚本，并向其支付satoshis. Bob看到付款被添加到块链并运送商品。
不幸的是，商品在运输途中受到轻微破坏。Charlie想要一个完整的退款，但Bob认为10%退款是足够的。他们转向Alice来解决这个问题。Alice要求Charlie的照片证据，以及Bob创建Charlie检查过的redeem脚本的副本.
在查看证据后，Alice认为40%的退款是足够的，所以她去创建并签署两个输出的交易，一个花费satoshis到Bob的公钥，剩下的40%花道Charlie的公钥。
在签名脚本中，Alice把她的签名和Bob创建的未哈希的redeem的副本放入其中。她向Bob和Charlie提供了不完整交易的副本。他们中的任何一个可以通过添加他的签名来完成它，以创建以下的签名脚本：
```
OP_O [A's signature][B's or C's signature][serialized redeem script]
```
当交易被广播到网络时，每个节点根据Charlie先前支付的P2SH输出检查签名脚本，确保redeem脚本和之前提供的redeem脚本哈希值相匹配。然后评估将两个签名用作输入数据的兑换脚本。假设兑换脚本验证成功，两个交易输出显示在Bob和Charlie的钱包中作为可支付余额。
然而，如果Alice创建并签名了一个交易，他们都不会同意，例如将所有的sato支付给A自己. Bob和Charlie可以找到一个新的仲裁员，并签署一个支付sato的交易到另一个2-of-3 multisig redeem脚本哈希，这个包括一个新的仲裁员的公钥。这意味着bob和charlie不用担心他们的仲裁员偷他们的钱。


